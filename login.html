<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Login • Recipe Roulette</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles/base.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
</head>
<body>
  <header class="topbar">
    <nav class="nav">
      <a href="/" class="brand">Recipe Roulette</a>
    </nav>
  </header>

  <main class="container">
    <div class="auth-container">
      <h1>Welcome to Recipe Roulette</h1>
      <p class="muted">Please sign in to access recipes and save your favorites</p>

      <div id="authTabs" class="tabs">
        <button class="tab-btn active" data-tab="signin">Sign In</button>
        <button class="tab-btn" data-tab="signup">Sign Up</button>
      </div>

      <!-- Sign In Form -->
      <form id="signInForm" class="auth-form card">
        <div class="field">
          <label for="signin-email">Email</label>
          <input type="email" id="signin-email" required autocomplete="email" />
        </div>
        <div class="field">
          <label for="signin-password">Password</label>
          <input type="password" id="signin-password" required autocomplete="current-password" />
        </div>
        <button type="submit" class="primary">Sign In</button>
        <div id="signin-error" class="error-message hidden"></div>
      </form>

      <!-- Sign Up Form -->
      <form id="signUpForm" class="auth-form card hidden">
        <div class="field">
          <label for="signup-email">Email</label>
          <input type="email" id="signup-email" required autocomplete="email" />
        </div>
        <div class="field">
          <label for="signup-password">Password</label>
          <input type="password" id="signup-password" required autocomplete="new-password" minlength="6" />
          <small class="muted">Minimum 6 characters</small>
        </div>
        <button type="submit" class="primary">Sign Up</button>
        <div id="signup-error" class="error-message hidden"></div>
        <div id="signup-success" class="success-message hidden">
          Account created! Please check your email to verify your account, then sign in.
        </div>
      </form>
    </div>
  </main>

  <footer class="footer">Data from TheMealDB • INST 377 Project</footer>

  <script type="module">
    import { signIn, signUp, onAuthStateChange, initSupabase } from '/scripts/auth.js';

    // Load Supabase config from API
    async function loadConfig() {
      try {
        const res = await fetch('/api/config');
        const config = await res.json();
        initSupabase(config.SUPABASE_URL, config.SUPABASE_ANON_KEY);
      } catch (e) {
        console.error('Failed to load config:', e);
      }
    }

    await loadConfig();

    const signInForm = document.getElementById('signInForm');
    const signUpForm = document.getElementById('signUpForm');
    const tabBtns = document.querySelectorAll('.tab-btn');
    const signInError = document.getElementById('signin-error');
    const signUpError = document.getElementById('signup-error');
    const signUpSuccess = document.getElementById('signup-success');

    // Tab switching
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        if (tab === 'signin') {
          signInForm.classList.remove('hidden');
          signUpForm.classList.add('hidden');
        } else {
          signInForm.classList.add('hidden');
          signUpForm.classList.remove('hidden');
        }
        signInError.classList.add('hidden');
        signUpError.classList.add('hidden');
        signUpSuccess.classList.add('hidden');
      });
    });

    // Sign In
    signInForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signInError.classList.add('hidden');
      
      const email = document.getElementById('signin-email').value;
      const password = document.getElementById('signin-password').value;

      try {
        await signIn(email, password);
        window.location.href = '/';
      } catch (error) {
        signInError.textContent = error.message || 'Failed to sign in';
        signInError.classList.remove('hidden');
      }
    });

    // Sign Up
    signUpForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      signUpError.classList.add('hidden');
      signUpSuccess.classList.add('hidden');
      
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;

      try {
        await signUp(email, password);
        signUpSuccess.classList.remove('hidden');
        signUpForm.reset();
      } catch (error) {
        signUpError.textContent = error.message || 'Failed to create account';
        signUpError.classList.remove('hidden');
      }
    });

    // Check if already authenticated
    onAuthStateChange((event, session) => {
      if (session) {
        window.location.href = '/';
      }
    });
  </script>
</body>
</html>

